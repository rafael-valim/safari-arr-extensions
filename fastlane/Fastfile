default_platform(:mac)

# ---------------------------------------------------------------------------
# Constants
# ---------------------------------------------------------------------------

APPS = {
  radarr: {
    name: "SafariRadarrExtension",
    display: "Radarr Adder",
    identifier: "com.RV.radarradder.webapp",
    metadata_path: "fastlane/metadata_radarr",
  },
  sonarr: {
    name: "SafariSonarrExtension",
    display: "Sonarr Adder",
    identifier: "com.RV.sonarradder.webapp",
    metadata_path: "fastlane/metadata_sonarr",
  },
}.freeze

# ---------------------------------------------------------------------------
# Helpers
# ---------------------------------------------------------------------------

# Read a credential from macOS Keychain, falling back to an environment variable.
# Note: macOS `security -w` returns hex-encoded output for passwords containing
# newlines (like P8 keys). We detect and decode hex automatically.
def keychain_or_env(account, env_var)
  value = `security find-generic-password -s "safari-arr-fastlane" -a "#{account}" -w 2>/dev/null`.strip
  if value.empty?
    ENV[env_var]
  elsif value.match?(/\A[0-9a-fA-F]+\z/) && value.length > 40
    [value].pack("H*")
  else
    value
  end
end

def api_key
  app_store_connect_api_key(
    key_id: keychain_or_env("key_id", "APP_STORE_CONNECT_API_KEY_KEY_ID"),
    issuer_id: keychain_or_env("issuer_id", "APP_STORE_CONNECT_API_KEY_ISSUER_ID"),
    key_content: keychain_or_env("key_content", "APP_STORE_CONNECT_API_KEY_KEY"),
    is_key_content_base64: false,
    in_house: false,
  )
end

def build_app(app)
  build_mac_app(
    project: "#{app[:name]}/#{app[:name]}.xcodeproj",
    scheme: app[:name],
    configuration: "Release",
    output_directory: "build",
    output_name: "#{app[:name]}.app",
    export_method: "app-store",
    export_team_id: "CJXZNY36RV",
    export_options: {
      provisioningProfiles: {
        app[:identifier] => "#{app[:identifier]} AppStore",
        "#{app[:identifier]}.Extension" => "#{app[:identifier]}.Extension AppStore",
      },
    },
    clean: true,
  )
end

def upload_metadata_for(app)
  begin
    deliver(
      app_identifier: app[:identifier],
      metadata_path: app[:metadata_path],
      platform: "osx",
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
      api_key: api_key,
      app_review_information: {},
    )
  rescue => e
    # Workaround for fastlane/fastlane#20538: first-version apps crash on
    # fetch_app_store_review_detail returning nil. Metadata is already
    # uploaded by the time this error occurs, so we log and continue.
    if e.message.include?("No data")
      UI.important("⚠️  Metadata uploaded but review detail fetch failed (known first-version bug). Continuing...")
    else
      raise e
    end
  end
end

def upload_screenshots_for(app)
  deliver(
    app_identifier: app[:identifier],
    metadata_path: app[:metadata_path],
    screenshots_path: "fastlane/screenshots",
    platform: "osx",
    skip_binary_upload: true,
    skip_screenshots: false,
    skip_metadata: true,
    force: true,
    api_key: api_key,
  )
end

def upload_binary_for(app)
  deliver(
    app_identifier: app[:identifier],
    platform: "osx",
    skip_binary_upload: false,
    skip_screenshots: true,
    skip_metadata: true,
    force: true,
    api_key: api_key,
  )
end

# ---------------------------------------------------------------------------
# Lanes
# ---------------------------------------------------------------------------

platform :mac do

  # --- Build ---

  desc "Build Radarr Adder"
  lane :build_radarr do
    build_app(APPS[:radarr])
  end

  desc "Build Sonarr Adder"
  lane :build_sonarr do
    build_app(APPS[:sonarr])
  end

  desc "Build both extensions"
  lane :build_all do
    build_app(APPS[:radarr])
    build_app(APPS[:sonarr])
  end

  # --- Upload metadata ---

  desc "Upload Radarr metadata to App Store Connect"
  lane :upload_metadata_radarr do
    upload_metadata_for(APPS[:radarr])
  end

  desc "Upload Sonarr metadata to App Store Connect"
  lane :upload_metadata_sonarr do
    upload_metadata_for(APPS[:sonarr])
  end

  # --- Upload screenshots ---

  desc "Upload Radarr screenshots to App Store Connect"
  lane :upload_screenshots_radarr do
    upload_screenshots_for(APPS[:radarr])
  end

  desc "Upload Sonarr screenshots to App Store Connect"
  lane :upload_screenshots_sonarr do
    upload_screenshots_for(APPS[:sonarr])
  end

  # --- Upload binary ---

  desc "Upload Radarr binary to App Store Connect"
  lane :upload_binary_radarr do
    upload_binary_for(APPS[:radarr])
  end

  desc "Upload Sonarr binary to App Store Connect"
  lane :upload_binary_sonarr do
    upload_binary_for(APPS[:sonarr])
  end

  # --- Full release ---

  desc "Build, upload binary, metadata, and screenshots for Radarr"
  lane :release_radarr do
    build_app(APPS[:radarr])
    upload_binary_for(APPS[:radarr])
    upload_metadata_for(APPS[:radarr])
    upload_screenshots_for(APPS[:radarr])
  end

  desc "Build, upload binary, metadata, and screenshots for Sonarr"
  lane :release_sonarr do
    build_app(APPS[:sonarr])
    upload_binary_for(APPS[:sonarr])
    upload_metadata_for(APPS[:sonarr])
    upload_screenshots_for(APPS[:sonarr])
  end

  desc "Full release for both extensions"
  lane :release_all do
    release_radarr
    release_sonarr
  end

end
